

## ICMP:Internet控制报文协议
### 报文格式
|<----------ICMP封装在IP数据报内部---------------------->|  
|------IP首部（20）字节------|--------ICMP报文-----------|  

### ICMP报文内部格式
|-----8位类型---|---8位代码----|-------16位较验和---------|  
|-------------------ICMP报文内容------------------------|  

### ICMP 控制报文分类
ICMP控制报文可分为查询类或差错类；   
查询类例如回显应达（ping),路由请求，时间戳请求，信息请求，地址掩码请求  
差错类包括不可达、重定向、超时、参数问题等等;  
* 回显应达：例如ping程序，回显计数等信息  
* 路由请求：初始化路由表的一种方法， 发送路由器请求报文，应答相邻路由表  
* 网络不可答： 发送IP报文中的目的IP不可答  
* 重定向： 主机发送给路由器a, 路由器a转发给路由器b, 若主机与路由器b在同一LAN上面（主机与B可直接互发，路由器A发送给主机重定向报文，便于主机更新路由表；   
## IP 选路
### IP选路优先级
* 搜索匹配的主机地址 (优先级最高)  
* 搜索匹配的网络地址 （优先级次之）  
* 搜索默认表项(优先级最低)  
```
网络地址：主机位全为零就是网络地址  
    1、如果是192的C段地址，那么，网络地址就是：192.168.1.0，地址掩码是：255.255.255.0。
    2、如果地址掩码是：255.255.0.0，那么网络地址就是：192.168.0.0。
    3、网络地址很大一部分是地址掩码决定的。
主机地址：  
    如IP地址是202.112.14.137，掩码是255.255.255.224，网络地址是202.112.14.128 。主机地址是202.112.14.137.
单播地址：普通主机地址一般就是单播地址  
广播地址：主机位全为1就是广播地址  
环回地址：127.xxx.xxx.xxx  
在二进制下，主机位全为零就是网络地址，主机位全为1就是广播地址，其它就是主机地址。
```

```
直接路由：在同一个子网内，可理解成二层交换   
间接路由：不在同个子网内，可理解成三层交换  
```

### IP静态选路方法
主机路由表的复杂性取决于主机所在网络的拓扑结构。  
1. 最简单的(也是最不令人感兴趣的)情况是主机根本没有与任何网络相连。TCP/IP协议仍然能用于这样 的主机,但是只能与自己本身通信!这种情况下的路由表只包含环回接口一项。
2. 接下来的情况是主机连在一个局域网上,只能访问局域网上的主机。这时路由表包含两项:一项是环回接口,另一项是局域网(如以太网)。
3. 如果主机能够通过单个路由器访问其他网络(如Internet)时,那么就要进行下一步。一般情况下增加一个默认表项指向该路由器。
4. 如果要新增其他的特定主机或网络路由,那么就要进行最后一步。在我们的例子中,到主机slip的路由要通过路由器bsdi就是这样的例子。我们根据上述IP操作的步骤使用这个路由表为主机svr4上的一些分组例子选择路由。
例如：  
+ 假定目的地址是主机sun, 140.252.13.33。首先进行主机地址的匹配。路由表中的两个主机地址表项(slip和localhost)均不匹配,接着进行网络地址匹配。这一次匹配成功,找到表项140.252.13.32(网络号和子网号都相同),因此使用emd0接口。这是一个直接路由,因此链路层地址将是目的端的地址。
+ 假定目的地址是主机slip,140.252.13.65。首先在路由表搜索主机地址,并找到一个匹配地址。这是一个间接路由,因此目的端的IP地址仍然是140.252.13.65,但是链路层地址必须是网关140.252.13.65的链路层地址,其接口名为emd0。
+ 这一次我们通过Internet给主机aw.com(192.207.117.2)发送一份数据报。首先在路由表中搜索主机地址,失败后进行网络地址匹配。最后成功地找到默认表项。该路由是一个间接路由,通过网关140.252 .13.33,并使用接口名为emd0。

### IP动态选路方法
**当相邻路由器之间进行通信,以告知对方每个路由器当前所连接的网络,这时就出现了动态选路**。  
路由器之间必须采用选路协议进行通信,这样的选路协议有很多种。最常用的选路协议为RIP协议。

## IGMP:Internet组管理协议
即多播组管理协议


## DNS:域名管理系统
域名系统(DNS)是一种用于TCP/IP应用程序的分布式数据库,它提供**主机名字和IP地址之间的转换**及有关电子邮件的选路信息。

1. 当用户在浏览器中输入www.qq.com域名访问该网站时，操作系统会先检查自己本地的hosts文件是否有这个网址映射关系，如果有，就先调用这个IP地址映射，完成域名解析。 
2. 如果hosts里没有这个域名的映射，则查找本地DNS解析器缓存，是否有这个网址映射关系，如果有，直接返回，完成域名解析。 
3. 如果hosts与本地DNS解析器缓存都没有相应的网址映射关系，首先会找TCP/ip参数中设置的首选DNS服务器，在此我们叫它本地DNS服务器，此服务器收到查询时，如果要查询的域名，包含在本地配置区域资源中，则返回解析结果给客户机，完成域名解析，此解析具有权威性。 
4. 如果要查询的域名，不由本地DNS服务器区域解析，但该服务器已缓存了此网址映射关系，则调用这个IP地址映射，完成域名解析，此解析不具有权威性。 
5. 如果本地DNS服务器本地区域文件与缓存解析都失效，则根据本地DNS服务器的设置（是否设置转发器）进行查询，如果未用转发模式，本地DNS就把请求发至13台根DNS，根DNS服务器收到请求后会判断这个域名(.com)是谁来授权管理，并会返回一个负责该顶级域名服务器的一个IP。本地DNS服务器收到IP信息后，将会联系负责.com域的这台服务器。这台负责.com域的服务器收到请求后，如果自己无法解析，它就会找一个管理.com域的下一级DNS服务器地址(qq.com)给本地DNS服务器。当本地DNS服务器收到这个地址后，就会找qq.com域服务器，重复上面的动作，进行查询，直至找到www.qq.com主机。 
6. 如果用的是转发模式，此DNS服务器就会把请求转发至上一级DNS服务器，由上一级服务器进行解析，上一级服务器如果不能解析，或找根DNS或把转请求转至上上级，以此循环。不管是本地DNS服务器用是是转发，还是根提示，最后都是把结果返回给本地DNS服务器，由此DNS服务器再返回给客户机。
